<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Rescue Fix</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        
        /* Giao diện chính */
        #ui-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; }
        #sidebar { pointer-events: auto; width: 250px; background: rgba(0,0,0,0.8); color: white; height: 100%; overflow-y: auto; display: flex; flex-direction: column; }
        .menu-item { padding: 15px; border-bottom: 1px solid #444; cursor: pointer; }
        .menu-item:hover { background: #444; }
        
        /* Loading */
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: black; color: white; padding: 20px; border-radius: 10px; display: none; z-index: 999; }
        
        /* Khi vào AR, ẩn hết giao diện thừa */
        body.ar-active #sidebar { display: none; }
        body.ar-active #ui-container { display: none; }
    </style>
    
    <script> window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } }; </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="loading">⏳ Đang tải...</div>

    <div id="ui-container">
        <div id="sidebar">
            <div style="padding: 20px; font-weight: bold; background: #222;">MENU BÀI TẬP</div>
            <div id="menu-content"></div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { ARButton } from 'three/addons/webxr/ARButton.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        // 1. SETUP SCENE
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xaaaaaa); // Mặc định nền xám

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 50);
        camera.position.set(0, 1, 3);

        // QUAN TRỌNG: alpha: true để hỗ trợ AR trong suốt
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.xr.enabled = true; // Bật WebXR
        document.body.appendChild(renderer.domElement);

        // Label Renderer (Hiển thị chữ)
        const labelRenderer = new CSS2DRenderer();
        labelRenderer.setSize(window.innerWidth, window.innerHeight);
        labelRenderer.domElement.style.position = 'absolute';
        labelRenderer.domElement.style.top = '0px';
        labelRenderer.domElement.style.pointerEvents = 'none';
        document.body.appendChild(labelRenderer.domElement);

        // Ánh sáng (QUAN TRỌNG ĐỂ KHÔNG BỊ TỐI OM)
        const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3);
        scene.add(light);
        const dirLight = new THREE.DirectionalLight(0xffffff, 3);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0,0,0);
        controls.update();

        // 2. TẠO KHỐI HỘP TEST (MẶC ĐỊNH SẼ THẤY CÁI NÀY)
        // Để kiểm tra xem Three.js có chạy không
        const testBox = new THREE.Mesh(
            new THREE.BoxGeometry(0.2, 0.2, 0.2), 
            new THREE.MeshStandardMaterial({ color: 0xff0000 })
        );
        testBox.position.set(0, 0, 0);
        scene.add(testBox); // Luôn có một cái hộp đỏ ở giữa

        // 3. XỬ LÝ AR (FIX LỖI MÀN HÌNH ĐEN)
        const arButton = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
        document.body.appendChild(arButton);

        const reticle = new THREE.Mesh(
            new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
            new THREE.MeshBasicMaterial()
        );
        reticle.matrixAutoUpdate = false;
        reticle.visible = false;
        scene.add(reticle);

        // --- SỰ KIỆN CHUYỂN ĐỔI CHẾ ĐỘ ---
        renderer.xr.addEventListener('sessionstart', () => {
            // VÀO AR: Xóa nền xám -> Thành trong suốt để thấy Camera
            scene.background = null; 
            renderer.setClearColor(0x000000, 0);
            document.body.classList.add('ar-active');
            
            // Ẩn hộp test và model đi, chờ đặt
            testBox.visible = false;
            if(currentModel) currentModel.visible = false;
            
            setTimeout(() => alert("Rà xuống sàn -> Thấy vòng tròn -> Chạm để đặt!"), 500);
        });

        renderer.xr.addEventListener('sessionend', () => {
            // THOÁT AR: Trả lại nền xám
            scene.background = new THREE.Color(0xaaaaaa);
            document.body.classList.remove('ar-active');
            testBox.visible = true;
            if(currentModel) {
                currentModel.visible = true;
                currentModel.scale.set(1,1,1);
            }
            // Reset camera
            camera.position.set(0, 1, 3);
            camera.lookAt(0,0,0);
        });

        // XỬ LÝ CHẠM MÀN HÌNH AR
        let hitTestSource = null;
        let hitTestSourceRequested = false;

        const controller = renderer.xr.getController(0);
        controller.addEventListener('select', () => {
            if (reticle.visible) {
                // Ưu tiên đặt model thật, nếu không có thì đặt hộp đỏ test
                const objectToPlace = currentModel ? currentModel : testBox;
                
                objectToPlace.position.setFromMatrixPosition(reticle.matrix);
                objectToPlace.visible = true;
                objectToPlace.scale.set(0.15, 0.15, 0.15); // Thu nhỏ cho vừa bàn
                
                if(!currentModel) alert("Đã đặt hộp Test (Do chưa chọn bài tập)");
            }
        });
        scene.add(controller);


        // 4. LOAD MODEL LOGIC
        const loader = new GLTFLoader();
        let currentModel = null;
        let mixer = null;

        window.loadModel3D = function(filePath, title) {
            document.getElementById('loading').style.display = 'block';
            
            if(currentModel) scene.remove(currentModel);
            
            // Fix URL
            const encodedPath = encodeURI(filePath);

            loader.load(encodedPath, (gltf) => {
                const root = gltf.scene;
                
                // Xử lý hiển thị Label/Nét đứt (Giữ nguyên logic cũ của bạn)
                root.traverse((child) => {
                    if (child.name.includes("Label")) {
                        const div = document.createElement('div');
                        div.className = 'math-label';
                        div.textContent = child.name.replace("Label_", "").split(".")[0];
                        div.style.color = 'black'; div.style.fontWeight='bold';
                        const l = new CSS2DObject(div);
                        child.add(l);
                        child.visible = false; 
                    }
                });

                currentModel = root;
                scene.add(root);
                
                // Ẩn hộp test đi vì đã có model thật
                testBox.visible = false;

                // Auto Fit Camera
                const box = new THREE.Box3().setFromObject(root);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3()).length();
                root.position.sub(center); // Đưa về 0,0,0

                camera.position.set(size, size, size);
                camera.lookAt(0,0,0);

                document.getElementById('loading').style.display = 'none';

            }, undefined, (err) => {
                console.error(err);
                alert("Lỗi tải file 3D! Đang hiển thị hộp đỏ test.");
                document.getElementById('loading').style.display = 'none';
                testBox.visible = true; // Fallback về hộp đỏ
            });
        }

        // 5. RENDER LOOP
        function render(timestamp, frame) {
            if (frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then((refSpace) => {
                        session.requestHitTestSource({ space: refSpace }).then((source) => {
                            hitTestSource = source;
                        });
                    });
                    hitTestSourceRequested = true;
                }

                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
                    } else { reticle.visible = false; }
                }
            }

            renderer.render(scene, camera);
            labelRenderer.render(scene, camera);
        }
        renderer.setAnimationLoop(render);

        // 6. MENU GENERATOR
        const menuContainer = document.getElementById('menu-content');
        if (typeof curriculumData !== 'undefined') {
            curriculumData.forEach(folder => {
                if(folder.children) {
                    folder.children.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'menu-item';
                        div.innerText = item.title;
                        div.onclick = () => loadModel3D(item.file, item.title);
                        menuContainer.appendChild(div);
                    });
                }
            });
        } else {
             menuContainer.innerHTML = "<div style='padding:10px'>⚠️ Không tìm thấy menu_data.js</div>";
        }
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
    
    <script src="menu_data.js"></script>
</body>
</html>
