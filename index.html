<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc H√¨nh H·ªçc 3D (Next-Gen UI)</title>
    <link rel="icon" href="data:,">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --primary: #2563eb;
            --text: #1e293b;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; display: flex; height: 100vh; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); color: var(--text); }
        
        /* KHI V√ÄO AR: ·∫®n to√†n b·ªô giao di·ªán */
        body.in-ar #ui-container { display: none !important; }
        body.in-ar #viewer-container { background: transparent !important; }

        /* LAYOUT CH√çNH */
        #ui-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; z-index: 10; }
        
        /* SIDEBAR (GLASSMORPHISM) */
        #sidebar { 
            pointer-events: auto; width: 320px; height: 96%; margin: 1%; 
            background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 20px; border: var(--glass-border); box-shadow: var(--shadow);
            display: flex; flex-direction: column; overflow: hidden; transition: transform 0.3s ease;
        }
        
        .brand { padding: 25px; font-size: 20px; font-weight: 800; color: var(--primary); border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; }
        #menu-content { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* MENU ITEMS */
        .menu-folder-title { padding: 12px 15px; font-weight: 600; cursor: pointer; border-radius: 10px; margin-bottom: 5px; transition: 0.2s; display: flex; justify-content: space-between; }
        .menu-folder-title:hover { background: rgba(0,0,0,0.05); }
        .submenu { display: none; padding-left: 10px; }
        .submenu.show { display: block; }
        .menu-item { padding: 10px 15px; font-size: 14px; cursor: pointer; border-radius: 8px; color: #475569; transition: 0.2s; margin-bottom: 2px; }
        .menu-item:hover { background: rgba(37, 99, 235, 0.1); color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; font-weight: 600; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }

        /* TEXT PANEL (B√äN PH·∫¢I HO·∫∂C D∆Ø·ªöI) */
        #text-panel { 
            pointer-events: auto; position: absolute; right: 20px; top: 20px; bottom: 80px; width: 300px;
            background: var(--glass-bg); backdrop-filter: blur(12px); border-radius: 20px; 
            border: var(--glass-border); box-shadow: var(--shadow); display: flex; flex-direction: column;
            overflow: hidden;
        }
        .panel-header { padding: 15px; background: rgba(255,255,255,0.5); font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; color: #64748b; }
        .panel-content { padding: 20px; overflow-y: auto; font-size: 14px; line-height: 1.6; color: #334155; flex: 1; }
        .panel-content b { color: #0f172a; }

        /* VIEWER */
        #viewer-container { flex: 1; position: relative; width: 100%; height: 100%; z-index: 1; }
        
        /* CONTROLS */
        #cam-toggle { 
            position: absolute; top: 20px; right: 340px; width: 45px; height: 45px;
            background: white; border-radius: 12px; border: none; box-shadow: var(--shadow);
            cursor: pointer; font-size: 20px; transition: 0.2s; pointer-events: auto; z-index: 20;
        }
        #cam-toggle:hover { transform: scale(1.1); }

        #mobile-toggle { display: none; position: absolute; top: 15px; left: 15px; z-index: 100; background: white; border: none; padding: 10px 15px; border-radius: 10px; box-shadow: var(--shadow); font-weight: bold; pointer-events: auto;}

        /* LOADING */
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px 40px; border-radius: 50px; box-shadow: var(--shadow); font-weight: 600; display: none; z-index: 1000; }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            #text-panel { display: none; } /* ·∫®n l·ªùi gi·∫£i tr√™n mobile cho g·ªçn, c√≥ th·ªÉ l√†m n√∫t b·∫≠t t·∫Øt sau */
            #cam-toggle { right: 20px; top: 70px; }
        }
        @media (max-width: 768px) {
            #sidebar { position: absolute; left: -340px; height: 90%; top: 50px; z-index: 50; transition: left 0.3s; }
            #sidebar.open { left: 0; }
            #mobile-toggle { display: block; }
        }
    </style>
</head>
<body>

    <div id="loading">‚ú® ƒêang x·ª≠ l√Ω 3D...</div>

    <div id="ui-container">
        <button id="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞ Menu</button>
        <button id="cam-toggle" title="ƒê·ªïi Camera" onclick="toggleCamera()">üßä</button>

        <div id="sidebar">
            <div class="brand">üìê H√åNH H·ªåC 3D</div>
            <div id="menu-content"></div>
        </div>

        <div id="text-panel">
            <div class="panel-header">üìÑ ƒê·ªÅ B√†i</div>
            <div class="panel-content" id="problem-text">Ch·ªçn b√†i t·∫≠p...</div>
            <div class="panel-header" style="border-top:1px solid #ddd">üí° L·ªùi Gi·∫£i</div>
            <div class="panel-content" id="solution-text" style="filter: blur(5px); cursor: pointer;" onclick="this.style.filter='none'">
                (Ch·∫°m ƒë·ªÉ xem l·ªùi gi·∫£i)
            </div>
        </div>
    </div>

    <div id="viewer-container">
        </div>

    <script src="menu_data.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        // --- 1. SETUP RENDERER & SCENE ---
        const viewer = document.getElementById('viewer-container');
        const scene = new THREE.Scene();
        // Kh√¥ng set background ·ªü ƒë√¢y, ƒë·ªÉ CSS lo (ho·∫∑c null cho AR)
        scene.background = null; 

        // Renderer ch·∫•t l∆∞·ª£ng cao
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, precision: 'highp' });
        renderer.setSize(viewer.clientWidth, viewer.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true; // B·∫≠t b√≥ng ƒë·ªï
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; // B√≥ng m·ªÅm
        renderer.outputColorSpace = THREE.SRGBColorSpace; // M√†u s·∫Øc chu·∫©n
        renderer.toneMapping = THREE.ACESFilmicToneMapping; // Tone m√†u ƒëi·ªán ·∫£nh
        renderer.xr.enabled = true; 
        viewer.appendChild(renderer.domElement);

        // Label Renderer
        const labelRenderer = new CSS2DRenderer();
        labelRenderer.setSize(viewer.clientWidth, viewer.clientHeight);
        labelRenderer.domElement.style.position = 'absolute'; labelRenderer.domElement.style.top = '0px'; labelRenderer.domElement.style.pointerEvents = 'none';
        viewer.appendChild(labelRenderer.domElement);

        // --- 2. CAMERA & CONTROLS ---
        const aspect = viewer.clientWidth / viewer.clientHeight;
        const frustumSize = 8;
        const orthoCamera = new THREE.OrthographicCamera(frustumSize * aspect / -2, frustumSize * aspect / 2, frustumSize / 2, frustumSize / -2, 0.1, 10000);
        const perspCamera = new THREE.PerspectiveCamera(50, aspect, 0.1, 10000);
        let activeCamera = orthoCamera;
        
        const controls = new OrbitControls(activeCamera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // --- 3. √ÅNH S√ÅNG (QUAN TR·ªåNG: FIX L·ªñI MODEL ƒêEN) ---
        function setupLighting() {
            // ƒê√®n m√¥i tr∆∞·ªùng (s√°ng ƒë·ªÅu)
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);

            // ƒê√®n ch√≠nh (m·∫∑t tr·ªùi)
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 1024;
            dirLight.shadow.mapSize.height = 1024;
            scene.add(dirLight);

            // ƒê√®n ph·ª• (ƒë√°nh t·ª´ d∆∞·ªõi l√™n cho ƒë·ª° t·ªëi m·∫∑t d∆∞·ªõi)
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.5);
            hemiLight.position.set(0, 20, 0);
            scene.add(hemiLight);
        }
        setupLighting();

        // --- 4. MATERIAL SYSTEM (SHADER ƒê·∫∏P) ---
        function createNiceMaterial(colorHex, isTransparent = true) {
            // MeshPhysicalMaterial: V·∫≠t li·ªáu cao c·∫•p nh·∫•t c·ªßa Three.js
            return new THREE.MeshPhysicalMaterial({
                color: colorHex || 0x3b82f6, // M√†u xanh d∆∞∆°ng hi·ªán ƒë·∫°i n·∫øu kh√¥ng c√≥ m√†u
                metalness: 0.1,
                roughness: 0.5,       // ƒê·ªô nh√°m v·ª´a ph·∫£i
                clearcoat: 1.0,       // L·ªõp ph·ªß b√≥ng nh∆∞ vecni
                clearcoatRoughness: 0.1,
                transparent: isTransparent,
                opacity: 0.85,        // H∆°i trong su·ªët ƒë·ªÉ nh√¨n xuy√™n
                side: THREE.DoubleSide,
                polygonOffset: true,
                polygonOffsetFactor: 1, // ƒê·∫©y m·∫∑t ra sau ƒë·ªÉ hi·ªán n√©t
            });
        }

        const lineMaterial = new THREE.LineBasicMaterial({ color: 0x1e293b, linewidth: 2 }); // N√©t ƒëen ƒë·∫≠m
        const dashedMaterial = new THREE.LineDashedMaterial({ color: 0x94a3b8, dashSize: 0.2, gapSize: 0.1 }); // N√©t ƒë·ª©t m√†u x√°m

        function getColorFromName(name) {
            const n = name.toLowerCase();
            if (n.includes('red')) return 0xef4444; 
            if (n.includes('green')) return 0x22c55e;
            if (n.includes('blue')) return 0x3b82f6; 
            if (n.includes('yellow')) return 0xeab308;
            if (n.includes('orange')) return 0xf97316;
            return null; 
        }

        // --- 5. LOGIC AR (T·ª∞ ƒê·ªòNG ·∫®N UI) ---
        const arButton = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
        // Style n√∫t AR cho ƒë·∫πp
        arButton.style.background = 'white'; 
        arButton.style.color = 'black';
        arButton.style.borderRadius = '20px';
        arButton.style.border = 'none';
        arButton.style.fontWeight = 'bold';
        arButton.style.padding = '10px 20px';
        arButton.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
        document.body.appendChild(arButton);

        const reticle = new THREE.Mesh(new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2), new THREE.MeshBasicMaterial({color: 0xffffff}));
        reticle.matrixAutoUpdate = false; reticle.visible = false; scene.add(reticle);

        renderer.xr.addEventListener('sessionstart', () => {
            document.body.classList.add('in-ar');
            scene.background = null; 
            if(currentModel) currentModel.visible = false;
            setTimeout(()=>alert("üì± AR MODE:\n1. R√† ƒëi·ªán tho·∫°i xu·ªëng s√†n\n2. ƒê·ª£i v√≤ng tr√≤n tr·∫Øng\n3. Ch·∫°m ƒë·ªÉ ƒë·∫∑t h√¨nh"), 500);
        });

        renderer.xr.addEventListener('sessionend', () => {
            document.body.classList.remove('in-ar');
            if(currentModel) { currentModel.visible = true; currentModel.scale.set(1,1,1); centerModel(currentModel); }
        });

        let hitTestSource = null; let hitTestSourceRequested = false;
        const controller = renderer.xr.getController(0);
        controller.addEventListener('select', () => {
            if (reticle.visible && currentModel) {
                currentModel.position.setFromMatrixPosition(reticle.matrix);
                currentModel.visible = true;
                currentModel.scale.set(0.15, 0.15, 0.15); // Thu nh·ªè trong AR
            }
        });
        scene.add(controller);

        // --- 6. LOAD MODEL & X·ª¨ L√ù ---
        const loader = new GLTFLoader();
        let currentModel = null;

        window.loadModel3D = function(filePath, title, fullText) {
            const loading = document.getElementById('loading'); loading.style.display = 'block';
            
            // X·ª≠ l√Ω Text
            document.getElementById('problem-text').innerHTML = "ƒêang t·∫£i...";
            const encodedPath = encodeURI(filePath);
            const textPath = encodedPath.replace('.glb', '.txt').replace('.gltf', '.txt');
            
            fetch(textPath).then(r=>r.text()).then(t=>{
                const p = t.split('====='); 
                document.getElementById('problem-text').innerHTML = p[0]; 
                document.getElementById('solution-text').innerHTML = p[1] || "(Ch∆∞a c√≥ l·ªùi gi·∫£i)";
                if(window.MathJax) MathJax.typesetPromise();
            }).catch(()=>{
                if(fullText) {
                    const p = fullText.split('====='); 
                    document.getElementById('problem-text').innerHTML = p[0];
                    document.getElementById('solution-text').innerHTML = p[1] || "";
                    if(window.MathJax) MathJax.typesetPromise();
                } else {
                    document.getElementById('problem-text').innerHTML = "<i>(Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÅ b√†i)</i>";
                }
            });

            // X·ª≠ l√Ω 3D
            if (currentModel) scene.remove(currentModel);
            
            loader.load(encodedPath, (gltf) => {
                const root = gltf.scene;
                
                root.traverse((child) => {
                    // X·ª≠ l√Ω Mesh (M·∫∑t ph·∫≥ng) -> D√πng Material ƒë·∫πp
                    if (child.isMesh) {
                        const color = getColorFromName(child.name);
                        child.material = createNiceMaterial(color);
                        child.castShadow = true;
                        child.receiveShadow = true;
                        
                        // Th√™m vi·ªÅn ƒëen (Edges) cho s·∫Øc n√©t
                        const edges = new THREE.LineSegments(
                            new THREE.EdgesGeometry(child.geometry, 20), // Ng∆∞·ª°ng g√≥c 20 ƒë·ªô
                            lineMaterial
                        );
                        child.add(edges);
                    }
                    
                    // X·ª≠ l√Ω N√©t ƒë·ª©t (DASH)
                    if (child.name.includes("DASH") && (child.isLine || child.isLineSegments)) {
                        child.material = dashedMaterial;
                        child.computeLineDistances();
                    }
                    
                    // X·ª≠ l√Ω Label (Ch·ªØ)
                    if (child.name.includes("Label")) {
                        const div = document.createElement('div');
                        div.className = 'math-label';
                        div.textContent = child.name.replace("Label_", "").split(".")[0].replace(/\(.*\)/, "");
                        // Style ch·ªØ label
                        div.style.fontFamily = "Times New Roman";
                        div.style.fontWeight = "bold";
                        div.style.fontSize = "18px";
                        div.style.textShadow = "0 0 3px white";
                        
                        const label = new CSS2DObject(div);
                        child.add(label);
                        child.visible = false; // ·∫®n object g·ªëc, ch·ªâ hi·ªán ch·ªØ
                    }
                });

                currentModel = root;
                scene.add(root);
                centerModel(root);
                loading.style.display = 'none';
                
                // ƒê√≥ng menu tr√™n mobile
                if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');

            }, undefined, (err) => {
                console.error(err); loading.style.display = 'none'; alert("L·ªói t·∫£i file 3D");
            });
        }

        function centerModel(model) {
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3()).length();
            
            model.position.sub(center); // V·ªÅ 0,0,0
            
            // Ch·ªânh camera v·ª´a kh√≠t
            orthoCamera.left = -size * aspect / 1.5; orthoCamera.right = size * aspect / 1.5;
            orthoCamera.top = size / 1.5; orthoCamera.bottom = -size / 1.5;
            orthoCamera.updateProjectionMatrix();
            orthoCamera.position.set(size, size, size); orthoCamera.lookAt(0,0,0);

            perspCamera.position.set(size, size/2, size*1.5); perspCamera.lookAt(0,0,0);
        }

        // --- 7. RENDER LOOP ---
        function render(timestamp, frame) {
            if (frame) { // AR Logic
                const session = renderer.xr.getSession();
                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then((ref) => {
                        session.requestHitTestSource({ space: ref }).then((src) => hitTestSource = src);
                    });
                    hitTestSourceRequested = true;
                }
                if (hitTestSource) {
                    const hits = frame.getHitTestResults(hitTestSource);
                    if (hits.length > 0) {
                        reticle.visible = true;
                        reticle.matrix.fromArray(hits[0].getPose(renderer.xr.getReferenceSpace()).transform.matrix);
                    } else { reticle.visible = false; }
                }
            }
            
            controls.update();
            renderer.render(scene, activeCamera);
            labelRenderer.render(scene, activeCamera);
        }
        renderer.setAnimationLoop(render);

        // --- 8. UI HELPERS ---
        window.toggleCamera = () => {
            const btn = document.getElementById('cam-toggle');
            if (activeCamera === orthoCamera) {
                activeCamera = perspCamera; btn.innerHTML = "üëÅÔ∏è";
            } else {
                activeCamera = orthoCamera; btn.innerHTML = "üßä";
            }
            controls.object = activeCamera;
            // G·ªçi l·∫°i centerModel ƒë·ªÉ reset g√≥c nh√¨n khi ƒë·ªïi cam
            if(currentModel) centerModel(currentModel); 
        }

        window.addEventListener('resize', () => {
            const w = viewer.clientWidth; const h = viewer.clientHeight;
            renderer.setSize(w, h); labelRenderer.setSize(w, h);
            const a = w/h;
            perspCamera.aspect = a; perspCamera.updateProjectionMatrix();
            const s = 8; 
            orthoCamera.left = -s*a/2; orthoCamera.right = s*a/2; orthoCamera.top = s/2; orthoCamera.bottom = -s/2; orthoCamera.updateProjectionMatrix();
        });

        // MENU GENERATOR
        const menuContainer = document.getElementById('menu-content');
        if (typeof curriculumData !== 'undefined') {
            curriculumData.forEach(folder => {
                const folderDiv = document.createElement('div');
                folderDiv.innerHTML = `<div class="menu-folder-title" onclick="this.nextElementSibling.classList.toggle('show')">${folder.title} <span>‚ñº</span></div>`;
                const subDiv = document.createElement('div'); subDiv.className = 'submenu show'; // M·∫∑c ƒë·ªãnh m·ªü
                
                if(folder.children) {
                    folder.children.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'menu-item';
                        itemDiv.innerText = item.title;
                        itemDiv.onclick = () => {
                            document.querySelectorAll('.menu-item').forEach(i=>i.classList.remove('active'));
                            itemDiv.classList.add('active');
                            loadModel3D(item.file, item.title, item.desc);
                        };
                        subDiv.appendChild(itemDiv);
                    });
                }
                folderDiv.appendChild(subDiv);
                menuContainer.appendChild(folderDiv);
            });
        }
    </script>
</body>
</html>
