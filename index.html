<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Xuyên Thấu</title>
    <style>
        /* BẮT BUỘC: Body và HTML phải trong suốt */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background-color: transparent !important; overflow: hidden; font-family: sans-serif; }
        
        /* Lớp nền màu xám (Chỉ hiện khi KHÔNG dùng AR) */
        #gray-background {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #e0e0e0; z-index: -1; /* Nằm dưới cùng */
        }

        /* Giao diện Menu */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; z-index: 10; }
        #sidebar { pointer-events: auto; width: 260px; background: rgba(44, 62, 80, 0.95); color: white; height: 100%; overflow-y: auto; display: flex; flex-direction: column; border-right: 1px solid #444; }
        .menu-item { padding: 12px 15px; border-bottom: 1px solid #34495e; cursor: pointer; font-size: 14px; }
        .menu-item:hover { background: #34495e; }
        .menu-title { padding: 20px; font-weight: bold; background: #1a252f; text-align: center; }

        /* Nút ẩn/hiện menu trên mobile */
        #mobile-menu-btn { pointer-events: auto; position: absolute; top: 10px; left: 10px; z-index: 20; padding: 8px 12px; background: #2c3e50; color: white; border: none; border-radius: 4px; display: none; }
        @media (max-width: 768px) { #mobile-menu-btn { display: block; } #sidebar { display: none; } #sidebar.show { display: flex; } }

        /* Loading */
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 25px; border-radius: 30px; display: none; z-index: 100; pointer-events: none; }
    </style>
    
    <script> window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } }; </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="gray-background"></div>

    <button id="mobile-menu-btn" onclick="document.getElementById('sidebar').classList.toggle('show')">☰ Menu</button>
    <div id="ui-layer">
        <div id="sidebar">
            <div class="menu-title">MENU BÀI TẬP</div>
            <div id="menu-content"></div>
        </div>
    </div>
    <div id="loading">⏳ Đang tải 3D...</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { ARButton } from 'three/addons/webxr/ARButton.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        // 1. SETUP
        const scene = new THREE.Scene();
        // TUYỆT ĐỐI KHÔNG SET MÀU NỀN Ở ĐÂY. ĐỂ NULL ĐỂ TRONG SUỐT.
        scene.background = null; 

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 50);
        camera.position.set(0, 2, 5);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); // alpha: true là bắt buộc
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.xr.enabled = true;
        renderer.setClearColor(0x000000, 0); // Xóa sạch mọi màu nền
        document.body.appendChild(renderer.domElement);

        const labelRenderer = new CSS2DRenderer();
        labelRenderer.setSize(window.innerWidth, window.innerHeight);
        labelRenderer.domElement.style.position = 'absolute'; labelRenderer.domElement.style.top = '0px'; labelRenderer.domElement.style.pointerEvents = 'none';
        document.body.appendChild(labelRenderer.domElement);

        const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3);
        scene.add(light);
        const controls = new OrbitControls(camera, renderer.domElement);

        // 2. AR SETUP (CƯỠNG CHẾ)
        const arButton = ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] });
        document.body.appendChild(arButton);

        const reticle = new THREE.Mesh(new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2), new THREE.MeshBasicMaterial());
        reticle.matrixAutoUpdate = false; reticle.visible = false;
        scene.add(reticle);

        // Hộp đỏ Test (Mặc định hiện)
        const testBox = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.2), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
        scene.add(testBox);

        let hitTestSource = null;
        let hitTestSourceRequested = false;

        // Xử lý chạm AR
        const controller = renderer.xr.getController(0);
        controller.addEventListener('select', () => {
            if (reticle.visible) {
                const target = currentModel ? currentModel : testBox;
                target.position.setFromMatrixPosition(reticle.matrix);
                target.visible = true;
                target.scale.set(0.1, 0.1, 0.1); // Thu nhỏ
            }
        });
        scene.add(controller);

        // 3. LOAD MODEL
        const loader = new GLTFLoader();
        let currentModel = null;

        window.loadModel3D = function(path) {
            document.getElementById('loading').style.display = 'block';
            if(currentModel) scene.remove(currentModel);
            
            // Fix URL
            const encodedPath = encodeURI(path);
            
            loader.load(encodedPath, (gltf) => {
                const root = gltf.scene;
                
                // Xử lý Label (Chuyển thành CSS2D)
                root.traverse((child) => {
                    if (child.name.includes("Label")) {
                        const div = document.createElement('div');
                        div.className = 'math-label';
                        div.textContent = child.name.replace("Label_", "").split(".")[0].replace(/\(.*\)/, "");
                        div.style.color='black'; div.style.fontWeight='bold'; div.style.fontSize='16px';
                        child.add(new CSS2DObject(div));
                        child.visible = false;
                    }
                });

                currentModel = root;
                scene.add(root);
                testBox.visible = false; // Ẩn hộp test

                // Auto Fit
                const box = new THREE.Box3().setFromObject(root);
                const size = box.getSize(new THREE.Vector3()).length();
                const center = box.getCenter(new THREE.Vector3());
                root.position.sub(center);
                camera.position.set(size, size, size); camera.lookAt(0,0,0);
                
                document.getElementById('loading').style.display = 'none';
                if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('show');
            }, undefined, (err) => {
                alert("Lỗi tải file (Kiểm tra lại tên trên GitHub)");
                document.getElementById('loading').style.display = 'none';
                testBox.visible = true; 
            });
        }

        // 4. LOGIC ẨN HIỆN UI (QUAN TRỌNG NHẤT)
        // Thay vì chờ event, ta kiểm tra mỗi khung hình
        function checkARState() {
            const isAR = renderer.xr.isPresenting; // Đang chạy AR?
            
            const bg = document.getElementById('gray-background');
            const ui = document.getElementById('ui-layer');
            const mobileBtn = document.getElementById('mobile-menu-btn');
            const arBtn = document.getElementById('ARButton'); // Nút mặc định của Three.js

            if (isAR) {
                // NẾU ĐANG AR: Ẩn sạch sẽ mọi thứ
                if(bg.style.display !== 'none') bg.style.display = 'none';
                if(ui.style.display !== 'none') ui.style.display = 'none';
                if(mobileBtn.style.display !== 'none') mobileBtn.style.display = 'none';
            } else {
                // NẾU KHÔNG AR: Hiện lại
                if(bg.style.display !== 'block') bg.style.display = 'block';
                if(ui.style.display !== 'flex') ui.style.display = 'flex';
                // Nút mobile chỉ hiện ở mobile
                if(window.innerWidth <= 768) mobileBtn.style.display = 'block';
            }
        }

        // 5. RENDER LOOP
        function render(timestamp, frame) {
            // Kiểm tra trạng thái AR để ẩn/hiện UI
            checkARState();

            // Logic AR Hit-test
            if (frame) {
                const session = renderer.xr.getSession();
                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then((ref) => {
                        session.requestHitTestSource({ space: ref }).then((src) => hitTestSource = src);
                    });
                    hitTestSourceRequested = true;
                }
                if (hitTestSource) {
                    const hits = frame.getHitTestResults(hitTestSource);
                    if (hits.length > 0) {
                        reticle.visible = true;
                        reticle.matrix.fromArray(hits[0].getPose(renderer.xr.getReferenceSpace()).transform.matrix);
                    } else { reticle.visible = false; }
                }
            }

            renderer.render(scene, camera);
            labelRenderer.render(scene, camera);
        }
        renderer.setAnimationLoop(render);

        // 6. MENU GENERATOR
        const menuContainer = document.getElementById('menu-content');
        if (typeof curriculumData !== 'undefined') {
            curriculumData.forEach(folder => {
                if(folder.children) {
                    folder.children.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'menu-item';
                        div.innerText = item.title;
                        div.onclick = () => loadModel3D(item.file);
                        menuContainer.appendChild(div);
                    });
                }
            });
        }
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
    <script src="menu_data.js"></script>
</body>
</html>
